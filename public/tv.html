<!DOCTYPE html>
<html>
<head>
	<title>Fubo TV Screen</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="preconnect" href="https://www.figma.com">
	<link rel="preconnect" href="https://embed.figma.com">
	<link rel="dns-prefetch" href="https://www.figma.com">
	<link rel="dns-prefetch" href="https://embed.figma.com">
	<style>
		body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
		iframe { width: 100%; height: 100%; border: none; }
	</style>
</head>
<body>
    <iframe id="figma-embed" src=""></iframe>

	<script src="/socket.io/socket.io.js"></script>
	<script>
		const socket = io({ transports: ['websocket'], upgrade: false });
		// Connection status and video optimization indicators
		(function(){
			const statusEl = document.createElement('div');
			statusEl.style.position = 'fixed';
			statusEl.style.bottom = '8px';
			statusEl.style.left = '8px';
			statusEl.style.padding = '6px 8px';
			statusEl.style.background = 'rgba(0,0,0,0.6)';
			statusEl.style.color = '#fff';
			statusEl.style.fontSize = '12px';
			statusEl.style.borderRadius = '4px';
			statusEl.style.zIndex = '9999';
			statusEl.innerText = 'connecting...';
			document.body.appendChild(statusEl);
			
			// Add video optimization indicator
			const videoOptEl = document.createElement('div');
			videoOptEl.style.position = 'fixed';
			videoOptEl.style.bottom = '8px';
			videoOptEl.style.right = '8px';
			videoOptEl.style.padding = '6px 8px';
			videoOptEl.style.background = 'rgba(0,128,0,0.6)';
			videoOptEl.style.color = '#fff';
			videoOptEl.style.fontSize = '12px';
			videoOptEl.style.borderRadius = '4px';
			videoOptEl.style.zIndex = '9999';
			videoOptEl.innerText = 'video optimized';
			document.body.appendChild(videoOptEl);
			
			// Add promo countdown indicator
			const countdownEl = document.createElement('div');
			countdownEl.style.position = 'fixed';
			countdownEl.style.top = '8px';
			countdownEl.style.right = '8px';
			countdownEl.style.padding = '8px';
			countdownEl.style.background = 'rgba(255,165,0,0.8)';
			countdownEl.style.color = '#fff';
			countdownEl.style.fontSize = '14px';
			countdownEl.style.borderRadius = '4px';
			countdownEl.style.zIndex = '9999';
			countdownEl.innerText = 'Video loading...';
			countdownEl.style.display = 'none';
			document.body.appendChild(countdownEl);
			
			// Function to start countdown after video loads
			function startPromoCountdown() {
				countdownEl.style.display = 'block';
				countdownEl.innerText = 'Promo in 10s';
				countdownEl.style.background = 'rgba(255,165,0,0.8)';
				
				let countdown = 10;
				const countdownInterval = setInterval(() => {
					countdown--;
					if (countdown > 0) {
						countdownEl.innerText = `Promo in ${countdown}s`;
					} else {
						countdownEl.innerText = 'Promo appearing...';
						countdownEl.style.background = 'rgba(255,0,0,0.8)';
						clearInterval(countdownInterval);
						
						// Hide countdown after promo appears
						setTimeout(() => {
							countdownEl.style.display = 'none';
						}, 3000);
					}
				}, 1000);
			}
			
			// Add frame testing interface
			const testEl = document.createElement('div');
			testEl.style.position = 'fixed';
			testEl.style.top = '8px';
			testEl.style.left = '8px';
			testEl.style.padding = '8px';
			testEl.style.background = 'rgba(0,0,0,0.8)';
			testEl.style.color = '#fff';
			testEl.style.fontSize = '11px';
			testEl.style.borderRadius = '4px';
			testEl.style.zIndex = '9999';
			testEl.innerHTML = `
				<div>Test Frames:</div>
				<button onclick="changeState('game_playing')" style="margin:2px;padding:4px;font-size:10px;">Game</button>
				<button onclick="changeState('sports_promo_focus_watchnow')" style="margin:2px;padding:4px;font-size:10px;">Sports</button>
				<button onclick="changeState('primetime_promo_focus_watchnow')" style="margin:2px;padding:4px;font-size:10px;">Primetime</button>
				<button onclick="changeState('sports_content')" style="margin:2px;padding:4px;font-size:10px;">Sports Video</button>
				<button onclick="changeState('primetime_content')" style="margin:2px;padding:4px;font-size:10px;">Primetime Video</button>
				<hr style="margin:4px 0;border-color:#666;">
				<div>Test Promos:</div>
				<button onclick="fetch('/test-sports')" style="margin:2px;padding:4px;font-size:10px;background:#4CAF50;">Test Sports</button>
				<button onclick="fetch('/test-entertainment')" style="margin:2px;padding:4px;font-size:10px;background:#FF9800;">Test Entertainment</button>
				<button onclick="fetch('/reset-game')" style="margin:2px;padding:4px;font-size:10px;background:#f44336;">Reset</button>
			`;
			document.body.appendChild(testEl);
			
			socket.on('connect', () => statusEl.innerText = 'connected');
			socket.on('disconnect', () => statusEl.innerText = 'disconnected');
		})();
		const figmaFrame = document.getElementById('figma-embed');

        const figmaLinks = {
            'game_playing': "https://www.figma.com/proto/8SRVqAPXzL0B9Fa2bmv3wk/Untitled?node-id=1-2&viewport=225%2C420%2C0.06&t=RGZxlwHFVsCU0VCO-0&scaling=contain&content-scaling=fixed&starting-point-node-id=1%3A2&show-proto-sidebar=1",
            'sports_promo_focus_watchnow': "https://www.figma.com/proto/8SRVqAPXzL0B9Fa2bmv3wk/Untitled?node-id=1-3&viewport=225%2C420%2C0.06&t=RGZxlwHFVsCU0VCO-0&scaling=contain&content-scaling=fixed&starting-point-node-id=1%3A3&show-proto-sidebar=1",
            'sports_promo_focus_dismiss': "https://www.figma.com/proto/8SRVqAPXzL0B9Fa2bmv3wk/Untitled?node-id=1-4&viewport=225%2C420%2C0.06&t=RGZxlwHFVsCU0VCO-0&scaling=contain&content-scaling=fixed&starting-point-node-id=1%3A4&show-proto-sidebar=1",
            'primetime_promo_focus_watchnow': "https://www.figma.com/proto/8SRVqAPXzL0B9Fa2bmv3wk/Untitled?node-id=1-5&viewport=225%2C420%2C0.06&t=RGZxlwHFVsCU0VCO-0&scaling=contain&content-scaling=fixed&starting-point-node-id=1%3A5&show-proto-sidebar=1",
            'primetime_promo_focus_dismiss': "https://www.figma.com/proto/8SRVqAPXzL0B9Fa2bmv3wk/Untitled?node-id=1-6&viewport=225%2C420%2C0.06&t=RGZxlwHFVsCU0VCO-0&scaling=contain&content-scaling=fixed&starting-point-node-id=1%3A6&show-proto-sidebar=1",
            'sports_content': "https://www.figma.com/proto/8SRVqAPXzL0B9Fa2bmv3wk/Untitled?node-id=1-7&viewport=-168%2C448%2C0.06&t=RGZxlwHFVsCU0VCO-0&scaling=contain&content-scaling=fixed&starting-point-node-id=1%3A7&show-proto-sidebar=1",
            'primetime_content': "https://www.figma.com/proto/8SRVqAPXzL0B9Fa2bmv3wk/Untitled?node-id=1-8&viewport=-168%2C448%2C0.06&t=RGZxlwHFVsCU0VCO-0&scaling=contain&content-scaling=fixed&starting-point-node-id=1%3A8&show-proto-sidebar=1"
        };

        function toEmbedUrl(url) {
            if (!url) return '';
            // If it's already an embed URL, keep it; else wrap inside Figma embed host
            if (url.includes('embed.figma.com')) return url;
            const encoded = encodeURIComponent(url);
            // Video-optimized embed settings: hide UI, disable hotspots, enable autoplay
            return `https://www.figma.com/embed?embed_host=notion&hotspot-hints=0&hide-ui=1&autoplay=1&url=${encoded}`;
        }

		let currentState = 'game_playing';

        function changeState(newState) {
			console.log('changeState called with:', newState);
			console.log('Available states:', Object.keys(figmaLinks));
			
			if (figmaLinks[newState]) {
                // Don't reload iframe for video content - just track state
                if (newState.includes('content')) {
                    // For content states, just update the state without reloading
                    currentState = newState;
                    console.log('Video content state changed to:', newState);
                    
                    // Show content indicator instead of loading
                    showContentIndicator(newState);
                } else {
                    // For promo states, we still need to change frames
                    const loadingEl = document.querySelector('.loading-indicator') || createLoadingIndicator();
                    loadingEl.style.display = 'block';
                    
                    const nextUrl = toEmbedUrl(figmaLinks[newState]);
                    figmaFrame.src = nextUrl;
                    currentState = newState;
                    
                    // Hide loading after iframe loads
                    setTimeout(() => {
                        loadingEl.style.display = 'none';
                    }, 500);
                }
			}
		}
        
        function showContentIndicator(contentType) {
            // Remove existing content indicator
            const existing = document.querySelector('.content-indicator');
            if (existing) existing.remove();
            
            // Create new content indicator
            const indicator = document.createElement('div');
            indicator.className = 'content-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 30px 60px;
                border-radius: 12px;
                font-size: 24px;
                z-index: 10000;
                text-align: center;
                font-weight: bold;
            `;
            
            if (contentType === 'sports_content') {
                indicator.innerHTML = 'üèà SPORTS CONTENT<br><span style="font-size:16px;opacity:0.8;">Video continues playing...</span>';
            } else if (contentType === 'primetime_content') {
                indicator.innerHTML = 'üì∫ PRIMETIME CONTENT<br><span style="font-size:16px;opacity:0.8;">Video continues playing...</span>';
            }
            
            document.body.appendChild(indicator);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.style.opacity = '0';
                    indicator.style.transition = 'opacity 1s';
                    setTimeout(() => {
                        if (indicator.parentNode) indicator.remove();
                    }, 1000);
                }
            }, 3000);
        }
        
        function createLoadingIndicator() {
            const loadingEl = document.createElement('div');
            loadingEl.className = 'loading-indicator';
            loadingEl.innerHTML = 'Loading...';
            loadingEl.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 20px 40px;
                border-radius: 8px;
                font-size: 18px;
                z-index: 10000;
                display: none;
            `;
            document.body.appendChild(loadingEl);
            return loadingEl;
        }

        // Initialize the iframe with the initial state
        console.log('Initializing with game_playing state...');
        changeState('game_playing');
        
        // Debug: Log all available states
        console.log('Available states:', Object.keys(figmaLinks));
        console.log('Current state:', currentState);
        
        // Add iframe load event handling for video content
        figmaFrame.addEventListener('load', function() {
            // Hide loading indicator when iframe content loads
            const loadingEl = document.querySelector('.loading-indicator');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            
            // Log state changes for debugging
            console.log('State changed to:', currentState);
            
            // Start promo countdown only after the initial game_playing frame loads
            if (currentState === 'game_playing') {
                console.log('Game frame loaded, starting promo countdown...');
                // Small delay to ensure video is fully loaded
                setTimeout(() => {
                    startPromoCountdown();
                }, 1000);
            }
        });
        
        // Add error handling for iframe loading issues
        figmaFrame.addEventListener('error', function() {
            console.error('Error loading Figma content');
            const loadingEl = document.querySelector('.loading-indicator');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        });

		socket.on('show-promo', (data) => {
			console.log('Received show-promo event:', data);
			if (currentState === 'game_playing') {
				// Map the promo type to the correct state
				let targetState;
				if (data.promoType === 'sports_promo') {
					targetState = 'sports_promo_focus_watchnow';
				} else if (data.promoType === 'primetime_promo') {
					targetState = 'primetime_promo_focus_watchnow';
				} else {
					console.error('Unknown promo type:', data.promoType);
					return;
				}
				
				console.log('Changing to state:', targetState);
				changeState(targetState);
			} else {
				console.log('Not in game_playing state, current state:', currentState);
			}
		});
		
		// Handle reset to game playing
		socket.on('reset-to-game', () => {
			console.log('Resetting to game playing state');
			changeState('game_playing');
		});

		socket.on('tv-command', (data) => {
			const key = data.key;
			switch (currentState) {
				case 'sports_promo_focus_watchnow':
					if (key === 'down' || key === 'right') changeState('sports_promo_focus_dismiss');
					else if (key === 'ok') changeState('sports_content');
					break;
				case 'sports_promo_focus_dismiss':
					if (key === 'up' || key === 'left') changeState('sports_promo_focus_watchnow');
					else if (key === 'ok') changeState('game_playing');
					break;
				case 'primetime_promo_focus_watchnow':
					if (key === 'down' || key === 'right') changeState('primetime_promo_focus_dismiss');
					else if (key === 'ok') changeState('primetime_content');
					break;
				case 'primetime_promo_focus_dismiss':
					if (key === 'up' || key === 'left') changeState('primetime_promo_focus_watchnow');
					else if (key === 'ok') changeState('game_playing');
					break;
				case 'sports_content':
				case 'primetime_content':
					// From content states, any key returns to game playing
					if (key === 'ok' || key === 'up' || key === 'down' || key === 'left' || key === 'right') {
						changeState('game_playing');
					}
					break;
			}
		});
	</script>
</body>
</html>
