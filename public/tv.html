<!DOCTYPE html>
<html>
<head>
	<title>Fubo TV Screen</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="preconnect" href="https://www.figma.com">
	<link rel="preconnect" href="https://embed.figma.com">
	<link rel="dns-prefetch" href="https://www.figma.com">
	<link rel="dns-prefetch" href="https://embed.figma.com">
	<style>
		body, html { 
			margin: 0; 
			padding: 0; 
			height: 100%; 
			overflow: hidden; 
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: #000;
			color: #fff;
		}
		
		.loading-screen {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			z-index: 10000;
		}
		
		.loading-content {
			text-align: center;
			max-width: 600px;
			padding: 40px;
		}
		
		.loading-title {
			font-size: 48px;
			font-weight: bold;
			margin-bottom: 30px;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
		}
		
		.loading-subtitle {
			font-size: 24px;
			margin-bottom: 40px;
			opacity: 0.9;
		}
		
		.loading-instructions {
			font-size: 18px;
			line-height: 1.6;
			margin-bottom: 40px;
			opacity: 0.8;
		}
		
		.loading-progress {
			width: 100%;
			height: 8px;
			background: rgba(255,255,255,0.2);
			border-radius: 4px;
			overflow: hidden;
			margin-bottom: 20px;
		}
		
		.loading-bar {
			height: 100%;
			background: linear-gradient(90deg, #4CAF50, #45a049);
			width: 0%;
			transition: width 0.3s ease;
		}
		
		.loading-status {
			font-size: 16px;
			opacity: 0.7;
		}

		.step-status {
			margin-top: 8px;
			font-size: 14px;
			opacity: 0.85;
		}

		.loading-cta {
			margin-top: 24px;
			padding: 12px 20px;
			background: #00d084;
			color: #00130d;
			border: none;
			border-radius: 6px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			display: inline-block;
		}

		.loading-cta[disabled] {
			background: #666;
			color: #bbb;
			cursor: not-allowed;
			opacity: 0.6;
		}

		.loading-cta:active { transform: scale(0.99); }
		
		.tv-screen {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: none;
		}
		
		iframe { 
			width: 100%; 
			height: 100%; 
			border: none; 
		}
		
		.enter-hint {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background: rgba(0,0,0,0.8);
			color: #fff;
			padding: 10px 15px;
			border-radius: 6px;
			font-size: 14px;
			opacity: 0;
			transition: opacity 0.3s ease;
			pointer-events: none;
		}
		
		.enter-hint.show {
			opacity: 1;
		}
	</style>
</head>
<body>
	<!-- Loading Screen -->
	<div id="loading-screen" class="loading-screen">
		<div class="loading-content">
			<div class="loading-title">ðŸŽ¬ Fubo TV Prototype</div>
			<div class="loading-subtitle">Loading your TV experience...</div>
			<div class="loading-instructions">
				<strong>How to use:</strong><br>
				â€¢ Click "Begin" to start<br>
				â€¢ Watch the content automatically<br>
				â€¢ When you see an action prompt, press <strong>ENTER</strong> to continue<br>
				â€¢ The prototype will guide you through the experience<br>
				â€¢ Sit back and enjoy the show!
			</div>
			<div class="loading-progress">
				<div id="loading-bar" class="loading-bar"></div>
			</div>
			<div id="loading-status" class="loading-status">Initializing...</div>
			<div id="step-status" class="step-status">Step 1/3: Preloadingâ€¦</div>
			<button id="begin-btn" class="loading-cta">Click to begin</button>
		</div>
	</div>
	
	<!-- TV Screen -->
	<div id="tv-screen" class="tv-screen">
		<iframe id="figma-embed" src=""></iframe>
		<div id="enter-hint" class="enter-hint">Press ENTER to dismiss</div>
	</div>

	<script src="/socket.io/socket.io.js"></script>
		<script>
		const socket = io({ transports: ['websocket'], upgrade: false });
		const figmaFrame = document.getElementById('figma-embed');
		const loadingScreen = document.getElementById('loading-screen');
		const tvScreen = document.getElementById('tv-screen');
		const loadingBar = document.getElementById('loading-bar');
		const loadingStatus = document.getElementById('loading-status');
		const enterHint = document.getElementById('enter-hint');
		const beginBtn = document.getElementById('begin-btn');
		const stepStatus = document.getElementById('step-status');
		function setPhase(phase) {
			if (phase === 'preloading') stepStatus.textContent = 'Step 1/3: Preloadingâ€¦';
			if (phase === 'ready') stepStatus.textContent = 'Step 2/3: Ready â€“ click Begin to start';
			if (phase === 'starting') stepStatus.textContent = 'Step 3/3: Startingâ€¦';
			if (phase === 'playing') stepStatus.textContent = 'Playing';
		}

		// Figma prototype links
		const figmaLinks = {
			'game_playing': "https://www.figma.com/proto/MS5xgxLvmO3WCl40DKu89g/Yan-s-Sandbox?page-id=4337%3A33308&node-id=4465-39526&p=f&viewport=-1126%2C170%2C0.03&t=22e0SnBuCfLrC63X-9&scaling=scale-down&content-scaling=fixed&starting-point-node-id=4465%3A39526&show-proto-sidebar=1",
			'sports_promo_focus_watchnow': "https://www.figma.com/proto/MS5xgxLvmO3WCl40DKu89g/Yan-s-Sandbox?page-id=4337%3A33308&node-id=4482-207&p=f&viewport=-1126%2C170%2C0.03&t=22e0SnBuCfLrC63X-9&scaling=scale-down&content-scaling=fixed&starting-point-node-id=4482%3A207&show-proto-sidebar=1",
			'sports_promo_focus_dismiss': "https://www.figma.com/proto/MS5xgxLvmO3WCl40DKu89g/Yan-s-Sandbox?page-id=4337%3A33308&node-id=4414-39703&p=f&viewport=-1126%2C170%2C0.03&t=22e0SnBuCfLrC63X-9&scaling=scale-down&content-scaling=fixed&starting-point-node-id=4414%3A39703&show-proto-sidebar=1",
			'primetime_promo_focus_watchnow': "https://www.figma.com/proto/MS5xgxLvmO3WCl40DKu89g/Yan-s-Sandbox?page-id=4337%3A33308&node-id=4414-39748&p=f&viewport=-1126%2C170%2C0.03&t=22e0SnBuCfLrC63X-9&scaling=scale-down&content-scaling=fixed&starting-point-node-id=4414%3A39748&show-proto-sidebar=1"
		};

		let currentState = 'game_playing';

		// Convert Figma URLs to embed URLs
		function toEmbedUrl(url) {
			if (!url) return '';
			if (url.includes('embed.figma.com')) return url;
			const encoded = encodeURIComponent(url);
			// Fullscreen, no UI, optimized for TV experience
			return `https://www.figma.com/embed?embed_host=notion&hotspot-hints=0&hide-ui=1&autoplay=1&url=${encoded}`;
		}

		// Preload all Figma content for zero latency - sequential to avoid WebGL context issues
		async function preloadContent() {
			const states = Object.keys(figmaLinks);
			let loadedCount = 0;
			
			// Create a container for preload iframes
			const preloadContainer = document.createElement('div');
			preloadContainer.style.cssText = 'position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden;';
			document.body.appendChild(preloadContainer);
			
			// Preload states sequentially to avoid overwhelming WebGL contexts
			async function preloadNext(index) {
				if (index >= states.length) {
					// All content preloaded, enable CTA
					loadingStatus.textContent = 'All content ready! Click begin to start';
					beginBtn.disabled = false;
					setPhase('ready');
					// Clean up preload iframes now that cache is warm
					preloadContainer.remove();
					return;
				}
				
				const state = states[index];
				loadingStatus.textContent = `Preloading ${state.replace(/_/g, ' ')}...`;
				loadingBar.style.width = `${(index / states.length) * 100}%`;
				
				// Create hidden iframe to preload content
				const preloadFrame = document.createElement('iframe');
				preloadFrame.style.cssText = 'width:100px;height:100px;border:none;';
				preloadFrame.src = toEmbedUrl(figmaLinks[state]);
				
				// Wait for iframe to load, then move to next
				preloadFrame.onload = () => {
					// Wait for Figma to render, then preload next state
					setTimeout(() => {
						loadedCount++;
						loadingBar.style.width = `${(loadedCount / states.length) * 100}%`;
						loadingStatus.textContent = `Preloaded ${loadedCount}/${states.length} states...`;
						
						// Remove this iframe to free up WebGL context
						preloadFrame.remove();
						
						// Preload next state
						preloadNext(index + 1);
					}, 2000); // Extra render buffer for zero-latency
				};
				
				preloadContainer.appendChild(preloadFrame);
			}
			
			// Start sequential preloading
			preloadNext(0);
		}

		// Show TV screen and start experience after user click; keep overlay until iframe signals ready
		function showTVScreen() {
			// Keep the loading overlay visible while the main iframe is initializing
			tvScreen.style.display = 'block';
			loadingStatus.textContent = 'Starting...';
			
			figmaFrame.src = toEmbedUrl(figmaLinks['game_playing']);
			currentState = 'game_playing';
			
			let loaded = false;
			const readyTimeout = setTimeout(() => {
				if (!loaded) {
					loadingStatus.textContent = 'Almost there...';
				}
			}, 2500);
			
			figmaFrame.onload = () => {
				loaded = true;
				clearTimeout(readyTimeout);
				loadingScreen.style.display = 'none';
				setPhase('playing');
				console.log('Main iframe loaded, letting Figma prototype control the flow...');
			};
		}

		// We no longer control state changes - Figma prototype handles its own flow
		// This function is kept for testing purposes only
		function changeState(newState) {
			if (figmaLinks[newState]) {
				currentState = newState;
				figmaFrame.src = toEmbedUrl(figmaLinks[newState]);
			}
		}

		// Handle Enter key for dismissal - only when Figma shows action prompt
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Enter') {
				// Let Figma prototype handle the Enter key action
				// We're just providing the input method, not controlling the flow
				console.log('Enter key pressed - Figma prototype will handle the action');
			}
		});

		// Socket events for testing
		socket.on('show-promo', (data) => {
			if (data.promoType === 'sports_promo') {
				changeState('sports_promo_focus_watchnow');
			} else if (data.promoType === 'primetime_promo') {
				changeState('primetime_promo_focus_watchnow');
			}
		});

		socket.on('reset-to-game', () => {
			changeState('game_playing');
		});

		// Wire CTA to start once preloaded
		// Show CTA immediately but disabled until preload completes
		beginBtn.disabled = true;
		beginBtn.addEventListener('click', () => {
			beginBtn.disabled = true;
			beginBtn.textContent = 'Loading...';
			setPhase('starting');
			showTVScreen();
		});

		// Start preloading content
		console.log('Starting content preload...');
		setPhase('preloading');
		preloadContent();
	</script>
</body>
</html>
